<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Tutorial de Ansible</title>
    
    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/extra.css">
    <link rel="stylesheet" href="css/theme/sky.css">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="lib/css/zenburn.css">
    
    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>
  </head>
  <body>
    <div class="reveal">
      <div class="slides">

	<div class='footer'><a rel="license"
		 href="http://creativecommons.org/licenses/by-sa/4.0/"><img
		alt="Licencia de Creative Commons" style="border-width:0"
src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png"
/></a><br />This work is under a <a rel="license"
				    href="http://creativecommons.org/licenses/by-sa/4.0/">CC-BY-SA 4.0 license</a>.</div>

	<section><h1>Provisionando con Chef</h1>
	  <h2><code>@jjmerelo</code> para <a href='https://www.meetup.com/es-ES/Granada-Geek/'>Granada Geek</a> + @iv_gii</h2>
	</section>
	
	<section
          data-background='https://farm2.staticflickr.com/1958/44950672935_cf0236ff00_k_d.jpg'><h1>Provisionar
          == amueblar</h1>

        </section>

        <section><h1>1. Provisionar</h1>
          <h1 class='fragment'>2. Comprobar</h1>
        </section>

        <section><h1>Usando <code>chef-run</code></h1>
          <pre><code>chef-run
    -i .vagrant/machines/default/virtualbox/private_key
      vagrant@127.0.0.1:2222 package ruby action=install</code></pre>
          <img src='img/chef-run.png' alt='ejecutando'>
        </section>

        <section><h1><code>chef-run</code> es</h1>
          <pre><code>chef-run objetivo recurso nombre [otras cosas]</code></pre>
          <pre class='fragment'><code>chef-run localhost package ruby [..]</code></pre>

          <aside class='notes'>Se puede empezar fácilmente a usar chef
          por aquí. Las instrucciones, en <a
            href='https://www.chef.sh/docs/reference/chef-run/'>esta
          página</a>. Lo que va a hacer chef-run es instalar un
          cliente de chef en la máquina objetivo (en este caso,
          definida con Vagrant) y a continuación instalar el paquete
          correspondiente. Pero lo importante es entender el concepto
            de recurso.</aside>
        </section>
        
          <section data-background='https://farm2.staticflickr.com/1906/45698887222_b2d2b11dfe_k_d.jpg'>
          <h1><strong>Recursos</strong> → <em>tareas</em></h1>
          <h2 class='fragment'>Recurso + recurso +... → Receta</h2>

          <aside class='notes'>Los recursos vienen descritos aquí: <a
            href='https://docs.chef.io/resource.html'>About
            resources</a>. Hay como tres o cuatro webs de Chef. Es un lío.</aside>
          </section>

          <section><h2>Recursos →</h2>
            <h3 class='fragment'>Describen el estado deseado</h3>
            <h3 class='fragment'>Y los <strong>pasos</strong> para alcanzarlo</h3>
            <h3 class='fragment'>Y el <strong>tipo</strong></h3>
            <h3 class='fragment'>Y propiedades adicionales</h3>
          </section>

          <section><h1><code>chef-run</code> es</h1>
            <pre><code>chef-run localhost package ruby action=install</code></pre>
            <pre class='fragment'><code>chef-run localhost tipo-recurso recurso pasos</code></pre>
            <aside class='notes'>Así se usan los recursos directamente
              desde la línea de órdenes, y se ilustra como funciona.</aside>
          </section>

          <section
          data-background='https://farm5.staticflickr.com/4855/46148347441_fd7763c791_k_d.jpg'><h1><code>chef-run</code>
            se auto-instala</h1>
            <h2 class='fragment'>Necesita acceso
              <code>sudo</code></h2>
          </section>

          <section><h1>Usando recetas</h1>
            <pre><code>package 'git' do
  action :install
end
            </code></pre>

            <pre class='fragment'><code>chef-run -i path-to/private_key user@host git.rb</code></pre>
            <aside class='notes'>Guardada en
            <code>git.rb</code>. Usando, como anteriormente, un
            recurso y una acción a hacer con el mismo. Instalar esto,
            como en todos los casos, es imprescindible porque si no
            no funcionan los recursos que usen git.</aside>
          </section>

          <section><h1>Una receta</h1>

            <pre><code>git 'microservice' do
  repository 'https://github.com/JJ/microservices-broker'
  user 'vagrant'
  destination '/home/vagrant/microservice'
  action :checkout
end
            </code></pre>
            <aside class='notes'>En este caso se trata de usar un
              recurso llamado <code>git</code>. Hay <a
  href='https://docs.chef.io/resource_reference.html'>una buena
              cantidad de recursos que se pueden usar</a>, así como
              una serie de propiedades comunes y específicas para
              recursos determinados. En este caso, <code>action</code>
  es específica de este recurso en particular; en el resto algunas son
              genéricas como <code>user</code>
            </aside>
          </section>

          <section><h1>Sh*t happens</h1>
            <pre><code>apt_package 'ruby' do
  default_release '2.3'
end
            </code></pre>

            <pre class='fragment'><code>The converge of the remote host failed for the
following reason:

  Expected process to exit with [0], but received '100'
            </code></pre>
            <aside class='notes'>Podemos querer instalar alguna
            versión de Ruby que no sea la estándar. Sin embargo, esto
              se obtiene de los repositorios y puede que no lo
              encuentren. El error obtenido no es óptimo</aside>
          </section>

          <section><h1>Usa los logs, Luke</h1>
            <pre><code> tail   ~/.chef-workstation/logs/default.log</code></pre>
            <pre class='fragment'><code>STDOUT: ruby:
  Installed: 1:2.1.5+deb8u2
  Candidate: 1:2.1.5+deb8u2
  Version table:
 *** 1:2.1.5+deb8u2 0
        500 http://httpredir.debian.org/debian/ jessie/main amd64 Packages
        100 /var/lib/dpkg/status
STDERR: E: The value '2.3' is invalid for APT::Default-Release as such a release is not available in the sources
---- End output of ["apt-cache", "-o", "APT::Default-Release=2.3", "policy", "ruby"] ----
Ran ["apt-cache", "-o", "APT::Default-Release=2.3", "policy", "ruby"] returned 100
            </code></pre>

            <aside class='notes'>La verdad es que podía dar ese error
      desde el principio, pero menos da una piedra. Por lo menos
              averiguamos de dónde se baja las cosas</aside>
          </section>
      </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
			width: '95%',
			controls: true,
			progress: true,
			history: true,
				dependencies: [
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
